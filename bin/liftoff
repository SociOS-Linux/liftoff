#!/bin/bash
set -e

while getopts a:b:d:n:t: var; do
	case $var in
		a) arch="$OPTARG";;
		b) build_dir="$OPTARG";;
		d) distro="$OPTARG";;
		t) basetgz="$OPTARG";;
# Sensitive values hardcoded by default for security
#		c) config="$OPTARG";;
#		k) keyring="$OPTARG";;
#		p) pbuilderrc="$OPTARG";;
#		s) proxy="$OPTARG";;
# Don't forget to add newly enabled flags to getopts above!
	esac
done

# Passed to pbuilderrc
export DIST="$distro"
export ARCH="$arch"

# Sensitive paths
config="/usr/lib/liftoff/liftoff.conf"
keyring="/etc/apt/trusted.gpg"
pbuilderrc="/usr/lib/liftoff/pbuilderrc"

create_base() {
	echo "Creating pbuilder environment..."
	pbuilder create \
		--basetgz "$basetgz" \
		--configfile "$pbuilderrc" \
		--debootstrapopts --keyring="$keyring" \
		--http-proxy "$proxy"
}

build_package() {
	pdebuild \
		--buildresult "$build_dir" \
		--configfile "$pbuilderrc"
}

# Useful debug print
#echo "Architecture:  $arch"
#echo "Base:          $basetgz"
#echo "Configuration: $config"
#echo "Distribution:  $distro"
#echo "Keyring:       $keyring"
#echo "pbuilderrc:    $pbuilderrc"

# Create environment if it doesn't exist
if ( ! [ -e "$basetgz" ] || [ "$(stat --format=%s "$basetgz")" -eq 0 ] ); then
	create_base
fi

build_package # Build
