#!/bin/bash
set -e

while getopts a:b:c:d:k:l:n:p:s:t: var; do
	case $var in
		a) arch="$OPTARG";;
		b) build_dir="$OPTARG";;
		c) config="$OPTARG";;
		d) distro="$OPTARG";;
		k) keyring="$OPTARG";;
		l) log="$OPTARG";;
		p) pbuilderrc="$OPTARG";;
		s) proxy="$OPTARG";;
		t) basetgz="$OPTARG";;
	esac
done

create_pbuilder_environment() {
	echo "Creating pbuilder environment..."
	DIST="$distro" ARCH="$arch" pbuilder create \
		--configfile "$pbuilderrc" \
		--debootstrapopts --keyring="$keyring" \
		--http-proxy "$proxy"
}

build_package() {
	DIST="$distro" ARCH="$arch" pdebuild \
		--buildresult "$build_dir" \
		--configfile "$pbuilderrc" \
		--logfile "$log"
}

echo "ARCHITECTURE:  $arch"
echo "BASETGZ:       $basetgz"
echo "CONFIGURATION: $config"
echo "DISTRIBUTION:  $distro"
echo "KEYRING:       $keyring"
echo "LOG:           $log"
echo "PBUILDERRC:    $pbuilderrc"

# Create environment if it doesn't exist
if ( ! [ -e "$basetgz" ] || [ "$(stat --format=%s "$basetgz")" -eq 0 ] ); then
	create_pbuilder_environment
fi

build_package # Build
