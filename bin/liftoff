#!/bin/bash
set -e

while getopts a:b:c:d:k:n:p:s:t: var; do
	case $var in
		a) arch="$OPTARG";;
		b) build_dir="$OPTARG";;
		c) config="$OPTARG";;
		d) distro="$OPTARG";;
		k) keyring="$OPTARG";;
		p) pbuilderrc="$OPTARG";;
		s) proxy="$OPTARG";;
		t) basetgz="$OPTARG";;
	esac
done

create_pbuilder_environment() {
	echo "Creating pbuilder environment ..."
	DIST="$distro" ARCH="$arch" pbuilder create \
		--configfile "$pbuilderrc" \
		--debootstrapopts --keyring="$keyring" \
		--http-proxy "$proxy"
}

build_package() {
	DIST="$distro" ARCH="$arch" pdebuild \
		--buildresult "$build_dir" \
		--configfile "$pbuilderrc"
}

echo "Architecture:  $arch"
echo "Base:          $basetgz"
echo "Configuration: $config"
echo "Distribution:  $distro"
echo "Keyring:       $keyring"
echo "pbuilderrc:    $pbuilderrc"

# Create environment if it doesn't exist
if ( ! [ -e "$basetgz" ] || [ "$(stat --format=%s "$basetgz")" -eq 0 ] ); then
	create_pbuilder_environment
fi

build_package # Build
