#!/bin/bash
set -e

# Load configuration
config="/usr/lib/liftoff/liftoff.conf"
source "$config"

# Add repository keys
apt-key adv \
	--keyserver keyserver.ubuntu.com \
	--recv-keys "${keys[@]}"

# Start loop
for arch in $(echo "$target_archs") ;
	do for dist in $(echo "$target_distros") ;
		do
			build_dir=$(mktemp -d /tmp/build-result.XXX)
			build_log="$build_dir/build.log"
			liftoff \
				-a "${arch}" \
				-b "$build_dir" \
				-c "$config" \
				-d "${dist}" \
				-k "/etc/apt/trusted.gpg" \
				-l "$build_log" \
				-p "/usr/lib/liftoff/pbuilderrc" \
				-s "$proxy_url" \
				-t "/var/cache/liftoff/$(distro2codename -d "${dist}" -c "$config")-${arch}-base.tgz"
		done ;
	done
